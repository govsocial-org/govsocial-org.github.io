<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In building our Mastodon instance, we basically followed The Funky Penguin's Geek Cookbook, but with a few important changes. Some of these related to the specifics of deploying in GCP, and some related to our implementation choices for this instance."><meta name=author content="Anthony Rodgers"><link href=https://docs.govsocial.org/building/mastodon/ rel=canonical><link href=../fluxhelm/ rel=prev><link rel=icon href=../../images/govsocial_logo.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.8"><title>Building the Mastodon Instance |ãƒ»âˆ€ãƒ»</title><link rel=stylesheet href=../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style><link rel=stylesheet href=../../extras/css/icons.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script src=/js/i-am-groot.js></script><script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script><!-- <script async data-uid="708edea2ee" src="https://funkypenguin.ck.page/708edea2ee/index.js"></script> --><!-- For widgetbot --><!-- <script src='https://cdn.jsdelivr.net/npm/@widgetbot/crate@3' async defer>
  const button = new Crate({
      server: '396055506072109067', // Funky Penguin
      channel: '456689991326760973', // Cookbook channel
      // username: 'Website Reader',
      // color: '#000',
      notifications: true,
      indicator: true // most recent change
  })
  button.notify({
      content: 'Need a ðŸ¤š? Hot, sweaty geeks are waiting to chat to you! Click ðŸ‘‡',
      timeout: 100000
    })
</script> --></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#building-the-mastodon-instance class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> <style>.md-banner a,.md-banner a:focus,.md-banner a:hover{color:currentColor}.md-banner strong{white-space:nowrap}.md-banner .twitter{margin-left:.2em;color:#00acee}</style> <div align=center> <a href=https://github.com/sponsors/govsocial-org> Please consider supporting us via <strong>GitHub Sponsors</strong> </a> </div> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="GOVSocial Project Documentation" class="md-header__button md-logo" aria-label="GOVSocial Project Documentation" data-md-component=logo> <img src=../../images/govsocial_logo_white.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> GOVSocial Project Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Building the Mastodon Instance </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Follow system preferences" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Follow system preferences" for=__palette_3 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Burn my eyes!" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Burn my eyes!" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Love my eyes!" type=radio name=__palette id=__palette_3> <label class="md-header__button md-icon" title="Love my eyes!" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/govsocial-org/govsocial-org.github.io/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> govsocial-org.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../ class="md-tabs__link md-tabs__link--active"> Building GOVSocial </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="GOVSocial Project Documentation" class="md-nav__button md-logo" aria-label="GOVSocial Project Documentation" data-md-component=logo> <img src=../../images/govsocial_logo_white.png alt=logo> </a> GOVSocial Project Documentation </label> <div class=md-nav__source> <a href=https://github.com/govsocial-org/govsocial-org.github.io/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> govsocial-org.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../ >Building GOVSocial</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Building GOVSocial </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> Preparation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Preparation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../cluster/ class=md-nav__link> Creating the Cluster </a> </li> <li class=md-nav__item> <a href=../domains/ class=md-nav__link> DNS Domains </a> </li> <li class=md-nav__item> <a href=../email/ class=md-nav__link> Transactional Email </a> </li> <li class=md-nav__item> <a href=../storage/ class=md-nav__link> S3 Storage </a> </li> <li class=md-nav__item> <a href=../postgresql/ class=md-nav__link> PostgreSQL </a> </li> <li class=md-nav__item> <a href=../fluxhelm/ class=md-nav__link> Flux/Helm </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> Platform Installs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Platform Installs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Mastodon <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Mastodon </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#helm-chart-repository class=md-nav__link> Helm Chart Repository </a> </li> <li class=md-nav__item> <a href=#platform-namespace class=md-nav__link> Platform Namespace </a> </li> <li class=md-nav__item> <a href=#flux-kustomization class=md-nav__link> Flux Kustomization </a> </li> <li class=md-nav__item> <a href=#custom-configuration class=md-nav__link> Custom Configuration </a> <nav class=md-nav aria-label="Custom Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap class=md-nav__link> ConfigMap </a> <nav class=md-nav aria-label=ConfigMap> <ul class=md-nav__list> <li class=md-nav__item> <a href=#general class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=#secrets class=md-nav__link> Secrets </a> </li> <li class=md-nav__item> <a href=#ingress class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=#elastic-search class=md-nav__link> Elastic Search </a> </li> <li class=md-nav__item> <a href=#smtp class=md-nav__link> SMTP </a> </li> <li class=md-nav__item> <a href=#cloud-storage class=md-nav__link> Cloud Storage </a> </li> <li class=md-nav__item> <a href=#postgresql class=md-nav__link> PostgreSQL </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#helmrelease class=md-nav__link> HelmRelease </a> </li> <li class=md-nav__item> <a href=#deploy-mastodon class=md-nav__link> Deploy Mastodon </a> </li> <li class=md-nav__item> <a href=#ingress_1 class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=#load-balancer class=md-nav__link> Load Balancer </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#helm-chart-repository class=md-nav__link> Helm Chart Repository </a> </li> <li class=md-nav__item> <a href=#platform-namespace class=md-nav__link> Platform Namespace </a> </li> <li class=md-nav__item> <a href=#flux-kustomization class=md-nav__link> Flux Kustomization </a> </li> <li class=md-nav__item> <a href=#custom-configuration class=md-nav__link> Custom Configuration </a> <nav class=md-nav aria-label="Custom Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap class=md-nav__link> ConfigMap </a> <nav class=md-nav aria-label=ConfigMap> <ul class=md-nav__list> <li class=md-nav__item> <a href=#general class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=#secrets class=md-nav__link> Secrets </a> </li> <li class=md-nav__item> <a href=#ingress class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=#elastic-search class=md-nav__link> Elastic Search </a> </li> <li class=md-nav__item> <a href=#smtp class=md-nav__link> SMTP </a> </li> <li class=md-nav__item> <a href=#cloud-storage class=md-nav__link> Cloud Storage </a> </li> <li class=md-nav__item> <a href=#postgresql class=md-nav__link> PostgreSQL </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#helmrelease class=md-nav__link> HelmRelease </a> </li> <li class=md-nav__item> <a href=#deploy-mastodon class=md-nav__link> Deploy Mastodon </a> </li> <li class=md-nav__item> <a href=#ingress_1 class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=#load-balancer class=md-nav__link> Load Balancer </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=building-the-mastodon-instance>Building the Mastodon Instance<a class=headerlink href=#building-the-mastodon-instance title="Permanent link">&para;</a></h1> <p>In building our Mastodon instance, we basically followed <a href=https://geek-cookbook.funkypenguin.co.nz/recipes/kubernetes/mastodon/ >The Funky Penguin's Geek Cookbook</a>, but with a few important changes. Some of these related to the specifics of deploying in GCP, and some related to our implementation choices for this instance.</p> <h2 id=helm-chart-repository>Helm Chart Repository<a class=headerlink href=#helm-chart-repository title="Permanent link">&para;</a></h2> <p>The first thing to do is to decide which Helm chart to use. We used the "official" one from <a href=https://github.com/mastodon/chart>the Mastodon repo</a>. As the Cookbook points out, this isn't a Helm repository, but a regular GitHub repository with the Helm chart in it. There is also a <a href=https://github.com/bitnami/charts/tree/main/bitnami/mastodon>Bitnami Helm chart</a>, which did not exist at the time we started (it was created on December 15, 2022), and which we have not tried.</p> <p><strong>NOTE:</strong> In all the file examples below, the path is from the root of your repo. Refer to the <a href=/building/fluxhelm/#flux-repository-structure>Flux repo plan</a> if you're unsure where all the files go.</p> <p>Having decided which chart to use, you need to create the appropriate repository entry in your Flux repo, so Flux knows where to pull the chart from. Here is the <code>GitRepository</code> entry we use for the Mastodon repo chart (there is an example of a <a href=https://geek-cookbook.funkypenguin.co.nz/kubernetes/external-dns/#helmrepository>Bitnami Helm repo file</a> in the Cookbook):</p> <div class=highlight><span class=filename>/clusters/{my-cluster}/gitrepositories/gitrepository-mastodon.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.toolkit.fluxcd.io/v1beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1h0s</span>
<span class=w>  </span><span class=nt>ref</span><span class=p>:</span>
<span class=w>    </span><span class=nt>branch</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/mastodon/chart</span>
</code></pre></div> <h2 id=platform-namespace>Platform Namespace<a class=headerlink href=#platform-namespace title="Permanent link">&para;</a></h2> <p>Next, we will need to create a <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/ >Kubernetes namespace</a> for all the resources for our Mastodon instance. Namespaces create a logical boundary within your cluster, grouping related resources together:</p> <div class=highlight><span class=filename>/clusters/{my-cluster}/namespaces/namespace-mastodon.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
</code></pre></div> <h2 id=flux-kustomization>Flux Kustomization<a class=headerlink href=#flux-kustomization title="Permanent link">&para;</a></h2> <p>Now, we need to provide the instructions to Flux to connect to <strong>our</strong> repository (that reference was created when we <a href=/building/fluxhelm/#bootstrap-flux>bootstrapped Flux</a>), apply our custom deployment configuration, install it into the namespace, and run some health checks to make sure it worked. This uses a Kubernetes object called a <a href=https://kubectl.docs.kubernetes.io/references/kubectl/kustomize/ >Kustomization</a>:</p> <div class=highlight><span class=filename>/clusters/{my-cluster}/kustomizations/kustomization-mastodon.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.toolkit.fluxcd.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">15m</span>
<span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./mastodon</span>
<span class=w>  </span><span class=nt>prune</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w> </span><span class=c1># remove any elements later removed from the above path</span>
<span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2m</span><span class=w> </span><span class=c1># if not set, this defaults to interval duration, which is 1h</span>
<span class=w>  </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=w>  </span><span class=nt>validation</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class=w>  </span><span class=nt>healthChecks</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-web</span>
<span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-streaming</span>
<span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=c1>#    - apiVersion: apps/v1</span>
<span class=c1>#      kind: Deployment</span>
<span class=c1>#      name: mastodon-sidekiq</span>
<span class=c1>#      namespace: mastodon</span>
</code></pre></div> <p>The <code>spec.path:</code> entry refers to a <code>./mastodon</code> directory at the root of <strong>our</strong> repository. This tells Flux to look in there for the configuration information for the build (we'll create that in just a moment).</p> <p><strong>NOTE:</strong> <a href=https://geek-cookbook.funkypenguin.co.nz/recipes/kubernetes/mastodon/#kustomization>The Cookbook example</a> includes a <code>healthChecks</code> entry for <code>mastodon-sidekiq</code>. This doesn't work with the Mastodon Helm chart as there is no listener in the deployed pod, so we commented it out.</p> <h2 id=custom-configuration>Custom Configuration<a class=headerlink href=#custom-configuration title="Permanent link">&para;</a></h2> <p>This is where the magic really happens. We have told Flux to look in the <code>./mastodon</code> directory in our GitHub respository that we <a href=/building/fluxhelm/#bootstrap-flux>bootstrapped Flux</a> with earlier. Now, we populate that directory with the special sauce that makes the whole build work.</p> <h3 id=configmap>ConfigMap<a class=headerlink href=#configmap title="Permanent link">&para;</a></h3> <p>A <a href=https://kubernetes.io/docs/concepts/configuration/configmap/ >Kubernetes ConfigMap</a> is a set of name-value pairs that acts as a sort of configuration file for the services in your running pods. Because local storage in Kubernetes pods is ephemeral (it gets detroyed and re-created when the pod redeploys), we need a permanent way to store configuration information outside the pod's local file system.</p> <p>The ConfigMap takes the place of the flat file called <code>.env.production</code> in the Mastodon directory of a server-based system that would be lost when the pod restarts in a Kubernetes-based system. The Mastodon Helm chart creates this flat file in each pod from the contents of the ConfigMap.</p> <p>A Helm chart comes with a <code>values.yaml</code> file that is the analog of a default configuration file. We want to set those default values to the ones we want, so we use our own ConfigMap to "override" the default values. Just like we edit a default configuration file to change the values to what we want, our ConfigMap is basically a copy of the default one with the appropriate values changed. Here is the ConfigMap for our Mastoson instance (comments have been removed for brevity and clarity):</p> <div class=highlight><span class=filename>/mastodon/configmap-mastodon-helm-chart-value-overrides.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-helm-chart-value-overrides</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=nt>data</span><span class=p>:</span>
<span class=w>  </span><span class=nt>values.yaml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span><span class=w>  </span>
<span class=w>    </span><span class=no>image:</span>
<span class=w>      </span><span class=no>repository: tootsuite/mastodon</span>
<span class=w>      </span><span class=no>tag: &quot;v4.0.2&quot;</span>
<span class=w>      </span><span class=no>pullPolicy: IfNotPresent</span>

<span class=w>    </span><span class=no>mastodon:</span>
<span class=w>      </span><span class=no>createAdmin:</span>
<span class=w>        </span><span class=no>enabled: true</span>
<span class=w>        </span><span class=no>username: [redacted]</span>
<span class=w>        </span><span class=no>email: [redacted]</span>
<span class=w>      </span><span class=no>cron:</span>
<span class=w>        </span><span class=no>removeMedia:</span>
<span class=w>          </span><span class=no>enabled: true</span>
<span class=w>          </span><span class=no>schedule: &quot;0 0 * * 0&quot;</span>
<span class=w>      </span><span class=no>locale: en</span>
<span class=w>      </span><span class=no>local_domain: govsocial.org</span>
<span class=w>      </span><span class=no>web_domain: mastodon.govsocial.org</span>
<span class=w>      </span><span class=no>singleUserMode: false</span>
<span class=w>      </span><span class=no>authorizedFetch: false</span>
<span class=w>      </span><span class=no>persistence:</span>
<span class=w>        </span><span class=no>assets:</span>
<span class=w>          </span><span class=no>accessMode: ReadWriteMany</span>
<span class=w>          </span><span class=no>resources:</span>
<span class=w>            </span><span class=no>requests:</span>
<span class=w>              </span><span class=no>storage: 10Gi</span>
<span class=w>        </span><span class=no>system:</span>
<span class=w>          </span><span class=no>accessMode: ReadWriteMany</span>
<span class=w>          </span><span class=no>resources:</span>
<span class=w>            </span><span class=no>requests:</span>
<span class=w>              </span><span class=no>storage: 100Gi</span>
<span class=w>      </span><span class=no>s3:</span>
<span class=w>        </span><span class=no>enabled: true</span>
<span class=w>        </span><span class=no>force_single_request: true</span>
<span class=w>        </span><span class=no>access_key: &quot;[redacted]&quot;</span>
<span class=w>        </span><span class=no>access_secret: &quot;[redacted]&quot;</span>
<span class=w>        </span><span class=no>existingSecret: &quot;&quot;</span>
<span class=w>        </span><span class=no>bucket: &quot;mastodongov&quot;</span>
<span class=w>        </span><span class=no>endpoint: &quot;https://storage.googleapis.com&quot;</span>
<span class=w>        </span><span class=no>hostname: &quot;storage.googleapis.com&quot;</span>
<span class=w>        </span><span class=no>region: &quot;us&quot;</span>
<span class=w>        </span><span class=no>alias_host: &quot;&quot;</span>
<span class=w>      </span><span class=no>secrets:</span>
<span class=w>        </span><span class=no>secret_key_base: &quot;[redacted]&quot;</span>
<span class=w>        </span><span class=no>otp_secret: &quot;[redacted]&quot;</span>
<span class=w>        </span><span class=no>vapid:</span>
<span class=w>          </span><span class=no>private_key: &quot;[redacted]&quot;</span>
<span class=w>          </span><span class=no>public_key: &quot;[redacted]&quot;</span>
<span class=w>        </span><span class=no>existingSecret: &quot;&quot;</span>
<span class=w>      </span><span class=no>sidekiq:</span>
<span class=w>        </span><span class=no>podSecurityContext: {}</span>
<span class=w>        </span><span class=no>securityContext: {}</span>
<span class=w>        </span><span class=no>resources: {}</span>
<span class=w>        </span><span class=no>affinity: {}</span>
<span class=w>        </span><span class=no>workers:</span>
<span class=w>        </span><span class=no>- name: all-queues</span>
<span class=w>          </span><span class=no>concurrency: 25</span>
<span class=w>          </span><span class=no>replicas: 1</span>
<span class=w>          </span><span class=no>resources: {}</span>
<span class=w>          </span><span class=no>affinity: {}</span>
<span class=w>          </span><span class=no>queues:</span>
<span class=w>            </span><span class=no>- default,8</span>
<span class=w>            </span><span class=no>- push,6</span>
<span class=w>            </span><span class=no>- ingress,4</span>
<span class=w>            </span><span class=no>- mailers,2</span>
<span class=w>            </span><span class=no>- pull</span>
<span class=w>            </span><span class=no>- scheduler</span>
<span class=w>      </span><span class=no>smtp:</span>
<span class=w>        </span><span class=no>auth_method: plain</span>
<span class=w>        </span><span class=no>ca_file: /etc/ssl/certs/ca-certificates.crt</span>
<span class=w>        </span><span class=no>delivery_method: smtp</span>
<span class=w>        </span><span class=no>domain: notifications.govsocial.org</span>
<span class=w>        </span><span class=no>enable_starttls: &#39;never&#39;</span>
<span class=w>        </span><span class=no>enable_starttls_auto: false</span>
<span class=w>        </span><span class=no>from_address: mastodon@notifications.govsocial.org</span>
<span class=w>        </span><span class=no>openssl_verify_mode: none</span>
<span class=w>        </span><span class=no>port: 465</span>
<span class=w>        </span><span class=no>reply_to:</span>
<span class=w>        </span><span class=no>server: email-smtp.us-east-2.amazonaws.com</span>
<span class=w>        </span><span class=no>ssl: false</span>
<span class=w>        </span><span class=no>tls: true</span>
<span class=w>        </span><span class=no>login: [redacted]</span>
<span class=w>        </span><span class=no>password: [redacted]</span>
<span class=w>        </span><span class=no>existingSecret:</span>
<span class=w>      </span><span class=no>streaming:</span>
<span class=w>        </span><span class=no>port: 4000</span>
<span class=w>        </span><span class=no>workers: 1</span>
<span class=w>        </span><span class=no>base_url: null</span>
<span class=w>        </span><span class=no>replicas: 1</span>
<span class=w>        </span><span class=no>affinity: {}</span>
<span class=w>        </span><span class=no>podSecurityContext: {}</span>
<span class=w>        </span><span class=no>securityContext: {}</span>
<span class=w>        </span><span class=no>resources: {}</span>
<span class=w>      </span><span class=no>web:</span>
<span class=w>        </span><span class=no>port: 3000</span>
<span class=w>        </span><span class=no>replicas: 1</span>
<span class=w>        </span><span class=no>affinity: {}</span>
<span class=w>        </span><span class=no>podSecurityContext: {}</span>
<span class=w>        </span><span class=no>securityContext: {}</span>
<span class=w>        </span><span class=no>resources: {}</span>

<span class=w>      </span><span class=no>metrics:</span>
<span class=w>        </span><span class=no>statsd:</span>
<span class=w>          </span><span class=no>address: &quot;&quot;</span>

<span class=w>    </span><span class=no>ingress:</span>
<span class=w>      </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>annotations:</span>
<span class=w>      </span><span class=no>ingressClassName:</span>
<span class=w>      </span><span class=no>hosts:</span>
<span class=w>        </span><span class=no>- host: mastodongov.org</span>
<span class=w>          </span><span class=no>paths:</span>
<span class=w>            </span><span class=no>- path: &#39;/&#39;</span>
<span class=w>      </span><span class=no>tls:</span>
<span class=w>        </span><span class=no>- secretName: mastodon-tls</span>
<span class=w>          </span><span class=no>hosts:</span>
<span class=w>            </span><span class=no>- mastodon.local</span>

<span class=w>    </span><span class=no>elasticsearch:</span>
<span class=w>      </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>image:</span>
<span class=w>        </span><span class=no>tag: 7</span>

<span class=w>    </span><span class=no>postgresql:</span>
<span class=w>      </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>postgresqlHostname: [redacted]</span>
<span class=w>      </span><span class=no>postgresqlPort: 5432</span>
<span class=w>      </span><span class=no>auth:</span>
<span class=w>        </span><span class=no>database: mastodongov</span>
<span class=w>        </span><span class=no>username: mastodon</span>
<span class=w>        </span><span class=no>password: &quot;[redacted]&quot;</span>
<span class=w>        </span><span class=no>postgresPassword: &quot;[redacted]&quot;</span>

<span class=w>    </span><span class=no>redis:</span>
<span class=w>      </span><span class=no>enabled: true</span>
<span class=w>      </span><span class=no>hostname: &quot;&quot;</span>
<span class=w>      </span><span class=no>port: 6379</span>
<span class=w>      </span><span class=no>password: &quot;&quot;</span>

<span class=w>    </span><span class=no>service:</span>
<span class=w>      </span><span class=no>type: ClusterIP</span>
<span class=w>      </span><span class=no>port: 80</span>

<span class=w>    </span><span class=no>externalAuth:</span>
<span class=w>      </span><span class=no>oidc:</span>
<span class=w>        </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>saml:</span>
<span class=w>        </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>oauth_global:</span>
<span class=w>        </span><span class=no>omniauth_only: false</span>
<span class=w>      </span><span class=no>cas:</span>
<span class=w>        </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>pam:</span>
<span class=w>        </span><span class=no>enabled: false</span>
<span class=w>      </span><span class=no>ldap:</span>
<span class=w>        </span><span class=no>enabled: false</span>

<span class=w>    </span><span class=no>podSecurityContext:</span>
<span class=w>      </span><span class=no>runAsUser: 991</span>
<span class=w>      </span><span class=no>runAsGroup: 991</span>
<span class=w>      </span><span class=no>fsGroup: 991</span>

<span class=w>    </span><span class=no>securityContext: {}</span>

<span class=w>    </span><span class=no>serviceAccount:</span>
<span class=w>      </span><span class=no>create: true</span>
<span class=w>      </span><span class=no>annotations: {}</span>
<span class=w>      </span><span class=no>name: &quot;&quot;</span>

<span class=w>    </span><span class=no>podAnnotations: {}</span>

<span class=w>    </span><span class=no>jobAnnotations: {}</span>

<span class=w>    </span><span class=no>resources: {}</span>

<span class=w>    </span><span class=no>nodeSelector: {}</span>

<span class=w>    </span><span class=no>tolerations: []</span>

<span class=w>    </span><span class=no>affinity: {}</span>
</code></pre></div> <p>The quickest way to create this file is to create this much by hand:</p> <div class=highlight><span class=filename>/mastodon/configmap-mastodon-helm-chart-value-overrides.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-helm-chart-value-overrides</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=nt>data</span><span class=p>:</span>
<span class=w>  </span><span class=nt>values.yaml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span><span class=w>  </span>
</code></pre></div> <p>and then paste in the rest of it underneath from the <code>values.yaml</code> from the Helm chart repo you used, being careful to indent everything you paste in by 4 spaces (<a href=https://yaml.org/spec/1.2.2/ >YAML</a> is picky about indentation).</p> <h4 id=general>General<a class=headerlink href=#general title="Permanent link">&para;</a></h4> <p>You will want to set the <code>local_domain:</code> (and <code>web_domain:</code>, if it's different) values to those you configured when <a href=/building/domains/ >preparing your DNS domains</a>.</p> <p>You will also need to pick the <code>username:</code> and <code>email:</code> for the Mastodon account that will be the initial admin user for the instance. You can add other users to various roles in the instance once it's running.</p> <p><strong>NOTE:</strong> Our install didn't create this user - if this happens to you, there is a workaround that you can do once your instance is running.</p> <h4 id=secrets>Secrets<a class=headerlink href=#secrets title="Permanent link">&para;</a></h4> <p>Mastodon uses a set of secrets for client/server authentication, 2FA, and authentication between its various services. Here is the relevant section of the ConfigMap:</p> <div class=highlight><pre><span></span><code><span class=nt>secrets</span><span class=p>:</span>
<span class=w>  </span><span class=nt>secret_key_base</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=nt>otp_secret</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=nt>vapid</span><span class=p>:</span>
<span class=w>    </span><span class=nt>private_key</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>    </span><span class=nt>public_key</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=c1># -- you can also specify the name of an existing Secret</span>
<span class=w>  </span><span class=c1># with keys SECRET_KEY_BASE and OTP_SECRET and</span>
<span class=w>  </span><span class=c1># VAPID_PRIVATE_KEY and VAPID_PUBLIC_KEY</span>
<span class=w>  </span><span class=nt>existingSecret</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
</code></pre></div> <p>To obtain the <code>secret_key_base:</code> and <code>otp_secret:</code> values, you will need to install the <code>rake</code> package from the package manager on your CLI machine. Create a file named <code>rakefile</code> in your working directory with these contents:</p> <div class=highlight><span class=filename>rakefile</span><pre><span></span><code><span class=n>desc</span><span class=w> </span><span class=s1>&#39;Generate a cryptographically secure secret key (this is typically used to generate a secret for cookie sessions).&#39;</span>
<span class=n>task</span><span class=w> </span><span class=ss>:secret</span><span class=w> </span><span class=k>do</span>
<span class=w>  </span><span class=nb>require</span><span class=w> </span><span class=s1>&#39;securerandom&#39;</span>
<span class=w>  </span><span class=nb>puts</span><span class=w> </span><span class=no>SecureRandom</span><span class=o>.</span><span class=n>hex</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span>
<span class=k>end</span>
</code></pre></div> <p>Then, run <code>rake secret</code> twice, once for the <code>secret_key_base</code>, and once for the <code>otp_secret</code>, and paste the values into your ConfigMap.</p> <p>The <code>vapid</code> key is a public/private keypair. We used an <a href=https://www.attheminute.com/us/vapid-key-generator>online Vapid key generator</a> for these.</p> <h4 id=ingress>Ingress<a class=headerlink href=#ingress title="Permanent link">&para;</a></h4> <p>Note that the <code>ingress.enabled:</code> value is set to <code>false</code>. The chart doesn't contain a spec for the GKE Ingress, and we created ours by hand once our instance was up and running.</p> <h4 id=elastic-search>Elastic Search<a class=headerlink href=#elastic-search title="Permanent link">&para;</a></h4> <p>We also left <code>elasticsearch.enabled:</code> set to <code>false</code>. Elastic requires its own cluster, which would have increased our initial hosting costs considerably. We may add this feature (which allows users to perform full-text searches on their timelines) at some point.</p> <p>Now, let's walk through the specifics of how we configured Mastodon to deploy with the various services (AWS SES, Cloud Storage, and Cloud SQL) that we prepared earlier.</p> <h4 id=smtp>SMTP<a class=headerlink href=#smtp title="Permanent link">&para;</a></h4> <p>Here is the section of our ConfigMap that relates to the AWS SES service we <a href=/building/email/#setting-up-aws-ses>prepared earlier</a>:</p> <div class=highlight><pre><span></span><code><span class=nt>smtp</span><span class=p>:</span>
<span class=w>  </span><span class=nt>auth_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">plain</span>
<span class=w>  </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ssl/certs/ca-certificates.crt</span>
<span class=w>  </span><span class=nt>delivery_method</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">smtp</span>
<span class=w>  </span><span class=nt>domain</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">notifications.govsocial.org</span>
<span class=w>  </span><span class=nt>enable_starttls</span><span class=p>:</span><span class=w> </span><span class=s>&#39;never&#39;</span>
<span class=w>  </span><span class=nt>enable_starttls_auto</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=w>  </span><span class=nt>from_address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon@notifications.govsocial.org</span>
<span class=w>  </span><span class=nt>openssl_verify_mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
<span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">465</span>
<span class=w>  </span><span class=nt>reply_to</span><span class=p>:</span>
<span class=w>  </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">email-smtp.us-east-2.amazonaws.com</span>
<span class=w>  </span><span class=nt>ssl</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>  </span><span class=nt>login</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>redacted</span><span class="p p-Indicator">]</span>
<span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>redacted</span><span class="p p-Indicator">]</span>
<span class=c1># -- you can also specify the name of an existing Secret</span>
<span class=c1># with the keys login and password</span>
<span class=nt>existingSecret</span><span class=p>:</span>
</code></pre></div> <p>This took a surprising amount of trial and error to get working. If you have problems, and you have managed to get the rest of your Mastodon instance running, the Sidekiq Retries queue (in the <code>Administration</code> settings in Mastodon) is your friend. It will provide you with useful error messages to help you troubleshoot the problem.</p> <p>The <code>domain:</code> setting will be the custom domain that you set up and verified with SES, and the <code>from_address:</code> can be any email address from that domain. You should paste the values for <code>login:</code> and <code>password:</code> from the SMTP Credential you configured in the SES console, remembering that <code>login:</code> is the randomly generated account name for the credential, not the name of the account principal itself.</p> <p>The tricky part was getting the connection to work. We could not get <code>STARTTLS</code> on port <code>587</code> to work at all, and only got <a href=https://mailtrap.io/blog/starttls-ssl-tls/ >implicit TLS</a> working by setting <code>enable_starttls: 'never'</code>, <code>enable_starttls_auto: false</code>, <code>openssl_verify_mode: none</code>, <code>ssl: false</code>, and <code>tls: true</code>. </p> <h4 id=cloud-storage>Cloud Storage<a class=headerlink href=#cloud-storage title="Permanent link">&para;</a></h4> <p>Here is the section of our ConfigMap that relates to the S3-compatible storage we <a href=/building/storage/ >prepared earlier</a>:</p> <div class=highlight><pre><span></span><code><span class=nt>s3</span><span class=p>:</span>
<span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>  </span><span class=nt>force_single_request</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>  </span><span class=nt>access_key</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=nt>access_secret</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=c1># -- you can also specify the name of an existing Secret</span>
<span class=w>  </span><span class=c1># with keys AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY</span>
<span class=w>  </span><span class=nt>existingSecret</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<span class=w>  </span><span class=nt>bucket</span><span class=p>:</span><span class=w> </span><span class=s>&quot;mastodongov&quot;</span>
<span class=w>  </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s>&quot;https://storage.googleapis.com&quot;</span>
<span class=w>  </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=s>&quot;storage.googleapis.com&quot;</span>
<span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=s>&quot;us&quot;</span>
<span class=w>  </span><span class=c1># -- If you have a caching proxy, enter its base URL here.</span>
<span class=w>  </span><span class=nt>alias_host</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
</code></pre></div> <p>You'll paste in the <code>access_key:</code> and <code>access_secret:</code> values from the <a href=https://cloud.google.com/storage/docs/authentication/managing-hmackeys>HMAC key</a> that you created for your Cloud Storage bucket, and set <code>bucket:</code> to the name you chose for it.</p> <p>The only catch we stumbled on when getting this to work was the addition of <code>force_single_request: true</code>, as Google Cloud Storage cannot handle chunked requests.</p> <h4 id=postgresql>PostgreSQL<a class=headerlink href=#postgresql title="Permanent link">&para;</a></h4> <p>Here is the section of our ConfigMap that relates to the PostgreSQL database we <a href=/building/postgres/ >prepared earlier</a>:</p> <div class=highlight><pre><span></span><code><span class=nt>postgresql</span><span class=p>:</span>
<span class=w>  </span><span class=c1># -- disable if you want to use an existing db; in which case the values below</span>
<span class=w>  </span><span class=c1># must match those of that external postgres instance</span>
<span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=w>  </span><span class=nt>postgresqlHostname</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>redacted</span><span class="p p-Indicator">]</span>
<span class=w>  </span><span class=nt>postgresqlPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class=w>  </span><span class=nt>auth</span><span class=p>:</span>
<span class=w>  </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodongov</span>
<span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>  </span><span class=c1># you must set a password; the password generated by the postgresql chart will</span>
<span class=w>  </span><span class=c1># be rotated on each upgrade:</span>
<span class=w>  </span><span class=c1># https://github.com/bitnami/charts/tree/master/bitnami/postgresql#upgrade</span>
<span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=c1># Set the password for the &quot;postgres&quot; admin user</span>
<span class=w>  </span><span class=c1># set this to the same value as above if you&#39;ve previously installed</span>
<span class=w>  </span><span class=c1># this chart and you&#39;re having problems getting mastodon to connect to the DB</span>
<span class=w>  </span><span class=nt>postgresPassword</span><span class=p>:</span><span class=w> </span><span class=s>&quot;[redacted]&quot;</span>
<span class=w>  </span><span class=c1># you can also specify the name of an existing Secret</span>
<span class=w>  </span><span class=c1># with a key of password set to the password you want</span>
<span class=w>  </span><span class=c1># existingSecret: &quot;&quot;</span>
</code></pre></div> <p>The first thing to note is that <code>postgres.enabled:</code> is set to <code>false</code>. This seems counter-intuitive - after all, we need a PostgreSQL database for the thing to work. In this case, the <code>enabled:</code> setting really tells the Mastodon deployment whether or not to enable a database locally in the cluster or not. In our deployment, we did not want that - we wanted to use the Cloud SQL database that we already created.</p> <p>The <code>postgresqlHostname:</code> setting will be the internal IP address of your PostgreSQL instance.</p> <p>Remember that we created a separate database for each platform we are running, so we changed the <code>database:</code> and <code>username:</code> to match what we created. Because we are also using a different user for the platform database, we needed to set both the <code>password:</code> (which is the password of the account in the <code>username:</code> setting) and the <code>postgresPassword:</code> (which is the password of the default <code>postgres</code> account) to the correct values. Mastodon uses each for different database tasks, so it needs both passwords in this configuration.</p> <p>When you get to the actual <a href=/building/mastodon/#deploy-mastodon>deployment</a> and your pods spin up, you should notice a <a href=https://kubernetes.io/docs/concepts/workloads/controllers/job/ >Job</a> called <code>mastodon-db-migrate</code> spin up as well. This job is creating the correct database schema for your instance. Your other Mastodon pods may not be available until that job completes.</p> <p><strong>NOTE:</strong> You may find that the <code>mastodon-db-migrate</code> job doesn't run with <code>postgres.enabled</code> set to <code>false</code> (although our experience was based on incorrectly setting it to <code>true</code> in our initial deployment and desperately trying to switch to Cloud SQL after <a href=/building/mastodon/#deploy-mastodon>deploying Mastodon</a><sup id=fnref:1><a class=footnote-ref href=#fn:1>1</a></sup> ).</p> <p>YMMV with a correctly configured fresh install, but if that happens to you, here is how we fixed it. The <code>mastodon-web</code> and <code>mastodon-sidekiq</code> pods will fail to start, but the <code>mastodon-streaming</code> pod will because, unlike the other two, it is not dependent on a database connection. The dirty little secret is that all three pods are running the same Mastodon image, so we can use the running <code>mastodon-streaming</code> pod to access a running Mastodon service and the <code>rails</code> environment we need.</p> <p>Connect to the running <code>mastodon-streaming</code> pod from your CLI machine by entering this:</p> <p><div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>mastodon
</code></pre></div> <div class="no-copy highlight"><pre><span></span><code>mastodon-streaming-bb578b4bc-gzfr2<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span>
mastodon-streaming-bb578b4bc-nszjf<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span>
mastodon-streaming-bb578b4bc-wsv2l<span class=w>            </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span>
</code></pre></div> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>mastodon-streaming-bb578b4bc-wsv2l<span class=w> </span>-n<span class=w> </span>mastodon<span class=w> </span>/bin/sh
</code></pre></div></p> <p>It doesn't matter which pod you connect to, if there is more than one, like in the example above. Once you are connected to a pod, run the following:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span><span class=nb>export</span><span class=w> </span><span class=nv>OTP_SECRET</span><span class=o>=[</span>redacted<span class=o>]</span>
$<span class=w> </span><span class=nb>export</span><span class=w> </span><span class=nv>SECRET_KEY_BASE</span><span class=o>=[</span>redacted<span class=o>]</span>
$<span class=w> </span><span class=nv>RAILS_ENV</span><span class=o>=</span>production<span class=w> </span>bundle<span class=w> </span><span class=nb>exec</span><span class=w> </span>rails<span class=w> </span>db:migrate
</code></pre></div> <p>You should see the <code>mastodon-db-migrate</code> job appear in your <code>Workloads</code> in the Cloud Console, and this will prepare your database. Once the job is finished, your <code>mastodon-web</code> and <code>mastodon-sidekiq</code> pods should restart successfully.</p> <h2 id=helmrelease>HelmRelease<a class=headerlink href=#helmrelease title="Permanent link">&para;</a></h2> <p>Now that we have our instance-specific ConfigMap in place, we can create the HelmRelease that will pull the Helm chart from the repository we chose for it and apply our ConfigMap to it. Here is the HelmRelease file we use:</p> <div class=highlight><span class=filename>/mastodon/helmrelease-mastodon.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>      </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./</span>
<span class=w>      </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">15m</span>
<span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class=w>  </span><span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon</span>
<span class=w>  </span><span class=nt>valuesFrom</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-helm-chart-value-overrides</span>
<span class=w>    </span><span class=nt>valuesKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values.yaml</span><span class=w> </span>
</code></pre></div> <p>With all this in place, here is the sequence of events:</p> <ul> <li>The <code>/clusters/{my-cluster}/kustomizations/kustomization-mastodon.yaml</code> Kustomization tells Flux on that cluster to monitor the <code>./mastodon</code> path <strong>our</strong> repository (<code>name: flux-system</code>) for changes every <code>interval: 15m</code></li> <li>When a change is detected, it updates the <code>name: mastodon-helm-chart-value-overrides</code> ConfigMap from <strong>our</strong> repo on the cluster, and...</li> <li>pulls the <code>name: mastodon</code> HelmRelease, which points at the <strong>platform</strong> repository (<code>name: mastodon</code>) containing the Helm chart that builds the pods and services deploys the chart in our cluster, with their local <code>.env.production</code> files built from the updated ConfigMap.</li> <li>The <code>healthChecks</code> in the Kustomization are run to make sure everything deployed successfully.</li> </ul> <p><strong>NOTE:</strong> The <strong>platform</strong> repository is itself monitored for changes every <code>interval: 15m</code>, and changes in that will also trigger a Flux reconcilliation. If you want to avoid unexpected upgrades, you can specify <a href=https://hub.docker.com/r/tootsuite/mastodon/tags>a valid <code>image.tag</code></a> in your ConfigMap. This is particularly important now that v4.1 is imminent, and the published Helm Chart could change without warning.</p> <h2 id=deploy-mastodon>Deploy Mastodon<a class=headerlink href=#deploy-mastodon title="Permanent link">&para;</a></h2> <p>You can either wait for Flux to detect your changes, or you can speed up the process by running the following from your CLI machine:</p> <div class=highlight><pre><span></span><code>flux<span class=w> </span>reconcile<span class=w> </span><span class=nb>source</span><span class=w> </span>git<span class=w> </span>flux-system
</code></pre></div> <p>You can see the Mastodon pods by running the following from your CLI machine (or looking in your GKE console):</p> <p><div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>mastodon
</code></pre></div> <div class="no-copy highlight"><pre><span></span><code>mastodon-redis-master-0<span class=w>                       </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-redis-replicas-0<span class=w>                     </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-redis-replicas-1<span class=w>                     </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-redis-replicas-2<span class=w>                     </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-sidekiq-all-queues-7d8b8c596-456kx<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-sidekiq-all-queues-7d8b8c596-97rfv<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-sidekiq-all-queues-7d8b8c596-98d2x<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-streaming-5bdc55888b-95fbn<span class=w>           </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-streaming-5bdc55888b-cwnsv<span class=w>           </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-streaming-5bdc55888b-czh28<span class=w>           </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-web-56cc95dd99-k7mfg<span class=w>                 </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-web-56cc95dd99-n524q<span class=w>                 </span><span class=m>1</span>/1<span class=w>     </span>Running
mastodon-web-56cc95dd99-vmkxf<span class=w>                 </span><span class=m>1</span>/1<span class=w>     </span>Running
</code></pre></div></p> <p>That's it! You're done deploying your Mastodon instance on GKE! Now, we need to make sure people can access it.</p> <h2 id=ingress_1>Ingress<a class=headerlink href=#ingress_1 title="Permanent link">&para;</a></h2> <p>You will <a href=/building/mastodon/#ingress>remember</a> that we did not enable the ingress that is included in the Mastodon Helm chart and instead opted to configure the GKE Ingress by hand.</p> <p>You can do this in the console by going to <code>Services &amp; Ingress</code> in the GKE menu in Google Cloud Console. You will need an <code>External HTTPS Ingress</code> with two ingress paths to make Mastodon work properly, especially with mobile applications:</p> <ul> <li>A path for the <code>mastodon-streaming</code> service, with the path set to <code>/api/v1/streaming</code></li> <li>A path for the <code>mastodon-web</code> service, with the path set to <code>/*</code></li> </ul> <p>As part of creating an HTTPS ingress, you will need a TLS certificate. We opted to use a Google-manged certificate. The domain for the certificate needs to be for the <code>web_domain</code> of the instance (or <code>local_domain</code>, if <code>web_domain</code> is not set).</p> <p>The <code>spec</code> for the resulting ingress should look like this:</p> <div class=highlight><pre><span></span><code><span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>rules</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>http</span><span class=p>:</span>
<span class=w>      </span><span class=nt>paths</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<span class=w>          </span><span class=nt>service</span><span class=p>:</span>
<span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-web</span>
<span class=w>            </span><span class=nt>port</span><span class=p>:</span>
<span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
<span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/*</span>
<span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>backend</span><span class=p>:</span>
<span class=w>          </span><span class=nt>service</span><span class=p>:</span>
<span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">mastodon-streaming</span>
<span class=w>            </span><span class=nt>port</span><span class=p>:</span>
<span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4000</span>
<span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/api/v1/streaming</span>
<span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
</code></pre></div> <p>The Ingress will be allocated an external IP address that you should add as an <code>A</code> record for the instance hostname in your DNS record set. Your TLS certificate will not validate until that DNS record propogates (usually within half an hour or so).</p> <p>Once it's all up and running, you should be able to connect to your instance from your web browser!</p> <h2 id=load-balancer>Load Balancer<a class=headerlink href=#load-balancer title="Permanent link">&para;</a></h2> <p>For GOVSocial.org, we wanted our user accounts to have the scheme <code>{username}@govsocial.org</code>, rather than having the full domain of each platform in them, like <code>{username}@{platform}.govsocial.org</code>. This means that our <code>local_domain</code> in Mastodon is <code>govsocial.org</code>, while our <code>web_domain</code> is <code>mastodon.govsocial.org</code>.</p> <p>This poses challenges for federation, as any links to user profiles on other instances will intially connect to <code>govsocial.org</code> (the <code>local_domain</code>) instead of our <code>web_domain</code> and will need to be redirected. This redirection is handled by a <a href=https://docs.joinmastodon.org/spec/webfinger/ ><code>webfinger</code> service in Mastodon</a>.</p> <p>The load balancer needs to redirect requests for <code>govsocial.org/.well-known/webfinger</code> (which is where other instances think it is based on our username scheme) to <code>mastodon.govsocial.org/.well-known/webfinger</code> (where the service is actually listening).</p> <p>To do this, we deployed an <code>HTTPS (classic) Load Balancer</code> in the <code>Network Services -&gt; Load Balancing</code> menu in our Google Cloud Console. The setup is very similar to the <a href=#ingress_1>Ingress we set up earlier</a>. In fact, you will see the load balancer created by the Ingress in the list when you go there.</p> <p><strong>HINT:</strong> Don't mess with it :-) If you're the sort of person who can't help pressing big red buttons that say "DO NOT PRESS", it's okay - anything you change will eventually be reverted by the GKE configuration, but your ingress might be broken until that happens.</p> <p>Create a new <code>HTTPS (classic) Load Balancer</code> (this one supports the hostname and path redirect features we need). Despite the higher cost, we selected the Premium network tier, as it allows for the addition of services like <a href=https://cloud.google.com/armor/docs/cloud-armor-overview>Cloud Armor</a> and <a href=https://cloud.google.com/cdn/docs/overview>Cloud CDN</a> if the platform needs it in the future.</p> <p>For the Frontend configuration, make sure to create a new fixed external IP address and add the corresponding <code>A</code> record for <code>local_domain</code> in your DNS record set. Because we want to use HTTPS, you will need to create a TLS certificate for your <code>local_domain</code>. The certificate won't validate until this DNS record propogates (usually with half an hour or so).</p> <p>For the Backend configuration, pick the default <code>kube-system-default-http-backend-80</code> service (there will be a bunch of letters/numbers before and after it.) This service doesn't have anything listening on it, but it will be used for the mandatory default rule in the rules configuration.</p> <p>In the <code>Host and path rules</code>, create a <code>Prefix redirect</code> for your <code>local_domain</code>, set the <code>Host redirect</code> to your <code>web_domain</code>, and the <code>Paths</code> to <code>/.well-known/webfinger</code>. Select <code>301 - Moved Permanently</code> for the response, and make sure that <code>HTTPS redirect</code> is enabled.</p> <p>Save your configuration, and wait for it to become available in the Cloud Console.</p> <p><strong>NOTE:</strong> One of the advantages of having this load balancer in conjunction with our domain scheme is that it means that we can use the default path (<code>/*</code>) of GOVSocial.org for documentation and non-instance specific content. We created a similar rule in our load balancer for <code>/*</code> that redirects to <code>docs.govsocial.org</code>, which is what you are reading now. There is a whole other write-up for that!</p> <div class=footnote> <hr> <ol> <li id=fn:1> <p>Flux to the rescue again! This was one of the issues (the other was abandoning AutoPilot) that had us delete all the Mastodon workloads and start over. The postgreSQL configuration seems to be particularly "sticky" and, try as we might, we could not get the corrected configuration to take after the initial deployment.&#160;<a class=footnote-backref href=#fnref:1 title="Jump back to footnote 1 in the text">&#8617;</a></p> </li> </ol> </div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 1, 2023</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 Anthony Rodgers, GOVSocial </div> </div> <div class=md-social> <a href=https://mstdn.ca/@cunningpike target=_blank rel=noopener title=mstdn.ca class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> <a href=https://github.com/govsocial-org target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://docs.govsocial.org/ target=_blank rel=noopener title=docs.govsocial.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/></svg> </a> <a href=https://www.linkedin.com/in/anthonylrodgers target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=mailto:cunningpike@gmail.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4H7a5 5 0 0 0-5 5v11h18a2 2 0 0 0 2-2V9a5 5 0 0 0-5-5m-7 14H4V9a3 3 0 0 1 3-3 3 3 0 0 1 3 3v9m9-3h-2v-2h-4v-2h6v4M9 11H5V9h4v2Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.sections", "navigation.indexes", "navigation.top", "navigation.pruning", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "header.autohide", "announce.dismiss", "toc.follow"], "search": "../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.a00a7c5e.min.js></script> <script src=../../extras/javascript/plausible.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../../extras/javascript/tablesort.js></script> </body> </html>