<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="FediBlockHole is a Python tool that is designed to be installed on a machine and run from the command line. We could have installed it on our CLI VM and run it from there with a crontab entry to automate it, but there are a couple of disadvantages with this approach. Firstly, it would require our VM to be more stable than a spot VM, increasing our hosting costs. Secondly, the supported VM image in GCP comes with Python 3.9.x, and FediBlockHole requires at least version 3.10."><meta name=author content="Anthony Rodgers"><link href=https://docs.govsocial.org/building/fediblockhole/ rel=canonical><link href=../mastodon/ rel=prev><link href=../../operating/ rel=next><link rel=icon href=../../images/govsocial_logo.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.8"><title>Building a k8s FediBlockHole Cron Job - GOVSocial Project Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.0d440cfe.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style><link rel=stylesheet href=../../extras/css/icons.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#building-a-k8s-fediblockhole-cron-job class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> <a rel=me href=https://mstdn.ca/@cunningpike></a> <style>.md-banner a,.md-banner a:focus,.md-banner a:hover{color:currentColor}.md-banner strong{white-space:nowrap}.md-banner .twitter{margin-left:.2em;color:#00acee}</style> <div align=center> <a href=https://github.com/sponsors/govsocial-org> Please consider supporting us via <strong>GitHub Sponsors</strong> </a> </div> </div> <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script> </aside> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="GOVSocial Project Documentation" class="md-header__button md-logo" aria-label="GOVSocial Project Documentation" data-md-component=logo> <img src=../../images/govsocial_logo_white.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> GOVSocial Project Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Building a k8s FediBlockHole Cron Job </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Burn my eyes!" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Burn my eyes!" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Love my eyes!" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Love my eyes!" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/govsocial-org/govsocial-org.github.io/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> govsocial-org.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../ class="md-tabs__link md-tabs__link--active"> Building GOVSocial </a> </li> <li class=md-tabs__item> <a href=../../operating/ class=md-tabs__link> Operating GOVSocial </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="GOVSocial Project Documentation" class="md-nav__button md-logo" aria-label="GOVSocial Project Documentation" data-md-component=logo> <img src=../../images/govsocial_logo_white.png alt=logo> </a> GOVSocial Project Documentation </label> <div class=md-nav__source> <a href=https://github.com/govsocial-org/govsocial-org.github.io/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> govsocial-org.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../ >Building GOVSocial</a> <label for=__nav_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Building GOVSocial </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> Preparation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Preparation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../cluster/ class=md-nav__link> Creating the Cluster </a> </li> <li class=md-nav__item> <a href=../domains/ class=md-nav__link> DNS Domains </a> </li> <li class=md-nav__item> <a href=../email/ class=md-nav__link> Transactional Email </a> </li> <li class=md-nav__item> <a href=../storage/ class=md-nav__link> S3 Storage </a> </li> <li class=md-nav__item> <a href=../postgresql/ class=md-nav__link> PostgreSQL </a> </li> <li class=md-nav__item> <a href=../fluxhelm/ class=md-nav__link> Flux/Helm </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> Platform Installs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Platform Installs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../mastodon/ class=md-nav__link> Mastodon </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> FediBlockHole <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> FediBlockHole </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#containerizing-fediblockhole class=md-nav__link> Containerizing FediBlockHole </a> </li> <li class=md-nav__item> <a href=#creating-the-helm-chart class=md-nav__link> Creating the Helm Chart </a> <nav class=md-nav aria-label="Creating the Helm Chart"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#chart-file class=md-nav__link> Chart File </a> </li> <li class=md-nav__item> <a href=#helm-ignore-file class=md-nav__link> Helm Ignore File </a> </li> <li class=md-nav__item> <a href=#values-file class=md-nav__link> Values File </a> </li> <li class=md-nav__item> <a href=#templates class=md-nav__link> Templates </a> <nav class=md-nav aria-label=Templates> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cron-job class=md-nav__link> Cron Job </a> </li> <li class=md-nav__item> <a href=#helpers-file class=md-nav__link> Helpers File </a> </li> <li class=md-nav__item> <a href=#configuration-file class=md-nav__link> Configuration File </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#oauth-token class=md-nav__link> OAuth Token </a> </li> <li class=md-nav__item> <a href=#deploying-fediblockhole class=md-nav__link> Deploying FediBlockHole </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../operating/ >Operating GOVSocial</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Operating GOVSocial </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> General <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> General </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operating/documentation/ class=md-nav__link> Documentation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> Instances <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Instances </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operating/mastodon/ class=md-nav__link> Mastodon </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#containerizing-fediblockhole class=md-nav__link> Containerizing FediBlockHole </a> </li> <li class=md-nav__item> <a href=#creating-the-helm-chart class=md-nav__link> Creating the Helm Chart </a> <nav class=md-nav aria-label="Creating the Helm Chart"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#chart-file class=md-nav__link> Chart File </a> </li> <li class=md-nav__item> <a href=#helm-ignore-file class=md-nav__link> Helm Ignore File </a> </li> <li class=md-nav__item> <a href=#values-file class=md-nav__link> Values File </a> </li> <li class=md-nav__item> <a href=#templates class=md-nav__link> Templates </a> <nav class=md-nav aria-label=Templates> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cron-job class=md-nav__link> Cron Job </a> </li> <li class=md-nav__item> <a href=#helpers-file class=md-nav__link> Helpers File </a> </li> <li class=md-nav__item> <a href=#configuration-file class=md-nav__link> Configuration File </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#oauth-token class=md-nav__link> OAuth Token </a> </li> <li class=md-nav__item> <a href=#deploying-fediblockhole class=md-nav__link> Deploying FediBlockHole </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=building-a-k8s-fediblockhole-cron-job>Building a k8s FediBlockHole Cron Job<a class=headerlink href=#building-a-k8s-fediblockhole-cron-job title="Permanent link">&para;</a></h1> <p>FediBlockHole is a Python tool that is designed to be installed on a machine and run from the command line. We could have installed it on our CLI VM and run it from there with a crontab entry to automate it, but there are a couple of disadvantages with this approach. Firstly, it would require our VM to be more stable than a <a href=https://cloud.google.com/compute/docs/instances/spot>spot VM</a>, increasing our hosting costs. Secondly, the supported VM image in GCP comes with Python 3.9.x, and FediBlockHole requires at least version 3.10.</p> <p>Rather than embarking on that expedition, we decided to containerize FediBlockHole, and deploy a Kubernetes cron job that instantiates the container and runs the script.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>When we did this, we <strong>forked</strong> rather than <strong>cloning</strong> the <a href=https://github.com/eigenmagic/fediblockhole>FediBlockHole repo</a> into <a href=https://github.com/cunningpike/fediblockhole>our own repo</a>. We wanted to submit a <a href=https://github.com/eigenmagic/fediblockhole/pull/38>pull request</a> for ingrating our work back into the original project, and to keep our repo up to date with it. The following documentation is from that perspective. All repo paths are relative to the root of our forked repo.</p> </div> <h2 id=containerizing-fediblockhole>Containerizing FediBlockHole<a class=headerlink href=#containerizing-fediblockhole title="Permanent link">&para;</a></h2> <p>To prepare for containerizing FediBlockHole, we installed Docker on our CLI machine from its package manager:</p> <div class=highlight><pre><span></span><code>~$<span class=w> </span>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>docker.io
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>In a GCP Compute VM, the package is called <code>docker.io</code>. YMMV.</p> </div> <p>Next, we prepared a Dockerfile for the Docker container:</p> <div class=highlight><span class=filename>/container/Dockerfile</span><pre><span></span><code><span class=c># Use the official lightweight Python image.</span>
<span class=c># https://hub.docker.com/_/python</span>
<span class=k>FROM</span><span class=w> </span><span class=s>python:slim</span>

<span class=c># Copy local code to the container image.</span>
<span class=k>ENV</span><span class=w> </span>APP_HOME<span class=w> </span>/app
<span class=k>WORKDIR</span><span class=w> </span><span class=s>$APP_HOME</span>

<span class=c># Install production dependencies.</span>
<span class=k>RUN</span><span class=w> </span>pip<span class=w> </span>install<span class=w> </span>fediblockhole

<span class=k>USER</span><span class=w> </span><span class=s>1001</span>
<span class=c># Run the script on container startup.</span>
<span class=k>ENTRYPOINT</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;fediblock-sync&quot;</span><span class=p>]</span>
</code></pre></div> <p>We also made sure there was a Python-flavored Docker ignore file:</p> <div class=highlight><span class=filename>/container/.dockerignore</span><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
<span class="l l-Scalar l-Scalar-Plain">#README.md</span>
<span class="l l-Scalar l-Scalar-Plain">*.pyc</span>
<span class="l l-Scalar l-Scalar-Plain">*.pyo</span>
<span class="l l-Scalar l-Scalar-Plain">*.pyd</span>
<span class="l l-Scalar l-Scalar-Plain">__pycache__</span>
</code></pre></div> <p>Then, we built our Docker image:</p> <p><div class=highlight><pre><span></span><code>~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>build<span class=w> </span>https://github.com/<span class=o>[</span>user<span class=p>|</span>organization<span class=o>]</span>/fediblockhole.git#main:container<span class=w> </span>--no-cache
</code></pre></div> <div class="no-copy highlight"><pre><span></span><code>Successfully<span class=w> </span>built<span class=w> </span><span class=o>{</span>container-id<span class=o>}</span>
</code></pre></div></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The <code>--no-cache</code> option forces a refresh from the repo rather than using the local cache. This is important for updates.</p> </div> <p>Using the <code>{container-id}</code> from <code>docker build</code>, we annotated the container with the version of FediBlockHole it was built with (currently <code>0.4.2</code>), and <code>latest</code>:</p> <div class=highlight><pre><span></span><code>~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>image<span class=w> </span>tag<span class=w> </span><span class=o>{</span>container-id<span class=o>}</span><span class=w> </span>fediblockhole:latest
~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>image<span class=w> </span>tag<span class=w> </span><span class=o>{</span>container-id<span class=o>}</span><span class=w> </span>fediblockhole:0.4.2
~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>image<span class=w> </span>tag<span class=w> </span>fediblockhole:latest<span class=w> </span>ghcr.io/<span class=o>[</span>user<span class=p>|</span>organization<span class=o>]</span>/fediblockhole:latest
~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>image<span class=w> </span>tag<span class=w> </span>fediblockhole:0.4.2<span class=w> </span>ghcr.io/<span class=o>[</span>user<span class=p>|</span>organization<span class=o>]</span>/fediblockhole:0.4.2
</code></pre></div> <p>We signed into our GitHub repository with this command:</p> <div class=highlight><pre><span></span><code>~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>login<span class=w> </span>ghcr.io<span class=w> </span>-u<span class=w> </span><span class=o>{</span>user_name<span class=o>}</span>
</code></pre></div> <p>Once signed in, we pushed the image to our <code>Packages</code> in GitHub:</p> <div class=highlight><pre><span></span><code>~$<span class=w> </span>sudo<span class=w> </span>docker<span class=w> </span>push<span class=w> </span>-a<span class=w> </span>ghcr.io/<span class=o>[</span>user<span class=p>|</span>organization<span class=o>]</span>/fediblockhole
</code></pre></div> <p>The completed package can be found <a href=https://github.com/cunningpike/fediblockhole/pkgs/container/fediblockhole>here</a>.</p> <h2 id=creating-the-helm-chart>Creating the Helm Chart<a class=headerlink href=#creating-the-helm-chart title="Permanent link">&para;</a></h2> <p>Next, we wanted to leverage the Flux/Helm system <a href=../fluxhelm/ >we built earlier</a> to deploy a Kubernetes cron job in our cluster.</p> <h3 id=chart-file>Chart File<a class=headerlink href=#chart-file title="Permanent link">&para;</a></h3> <p>The first thing we needed was a <a href=https://helm.sh/docs/topics/charts/ >Helm chart</a>:</p> <div class=highlight><span class=filename>/chart/Chart.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=nt>description</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">FediBlockHole is a tool for keeping a Mastodon instance blocklist synchronised with remote lists.</span>

<span class=c1># A chart can be either an &#39;application&#39; or a &#39;library&#39; chart.</span>
<span class=c1>#</span>
<span class=c1># Application charts are a collection of templates that can be packaged into versioned archives</span>
<span class=c1># to be deployed.</span>
<span class=c1>#</span>
<span class=c1># Library charts provide useful utilities or functions for the chart developer. They&#39;re included as</span>
<span class=c1># a dependency of application charts to inject those utilities and functions into the rendering</span>
<span class=c1># pipeline. Library charts do not define any templates and therefore cannot be deployed.</span>
<span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">application</span>

<span class=c1># This is the chart version. This version number should be incremented each time you make changes</span>
<span class=c1># to the chart and its templates, including the app version.</span>
<span class=c1># Versions are expected to follow Semantic Versioning (https://semver.org/)</span>
<span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.0.0</span>

<span class=c1># This is the version number of the application being deployed. This version number should be</span>
<span class=c1># incremented each time you make changes to the application. Versions are not expected to</span>
<span class=c1># follow Semantic Versioning. They should reflect the version the application is using.</span>
<span class=nt>appVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.4.2</span>
</code></pre></div> <h3 id=helm-ignore-file>Helm Ignore File<a class=headerlink href=#helm-ignore-file title="Permanent link">&para;</a></h3> <p>We also created a Helm ignore file:</p> <div class=highlight><span class=filename>/chart/.helmignore</span><pre><span></span><code><span class=c1># A helm chart&#39;s templates and default values can be packaged into a .tgz file.</span>
<span class=c1># When doing that, not everything should be bundled into the .tgz file. This</span>
<span class=c1># file describes what to not bundle.</span>
<span class=c1>#</span>
<span class=c1># Manually added by us</span>
<span class=c1># --------------------</span>
<span class=c1>#</span>

<span class=c1># Boilerplate .helmignore from `helm create mastodon`</span>
<span class=c1># ---------------------------------------------------</span>
<span class=c1>#</span>
<span class=c1># Patterns to ignore when building packages.</span>
<span class=c1># This supports shell glob matching, relative path matching, and</span>
<span class=c1># negation (prefixed with !). Only one pattern per line.</span>
<span class="l l-Scalar l-Scalar-Plain">.DS_Store</span>
<span class="l l-Scalar l-Scalar-Plain"># Common VCS dirs</span>
<span class="l l-Scalar l-Scalar-Plain">.git/</span>
<span class="l l-Scalar l-Scalar-Plain">.gitignore</span>
<span class="l l-Scalar l-Scalar-Plain">.bzr/</span>
<span class="l l-Scalar l-Scalar-Plain">.bzrignore</span>
<span class="l l-Scalar l-Scalar-Plain">.hg/</span>
<span class="l l-Scalar l-Scalar-Plain">.hgignore</span>
<span class="l l-Scalar l-Scalar-Plain">.svn/</span>
<span class="l l-Scalar l-Scalar-Plain"># Common backup files</span>
<span class="l l-Scalar l-Scalar-Plain">*.swp</span>
<span class="l l-Scalar l-Scalar-Plain">*.bak</span>
<span class="l l-Scalar l-Scalar-Plain">*.tmp</span>
<span class="l l-Scalar l-Scalar-Plain">*.orig</span>
<span class="l l-Scalar l-Scalar-Plain">*~</span>
<span class="l l-Scalar l-Scalar-Plain"># Various IDEs</span>
<span class="l l-Scalar l-Scalar-Plain">.project</span>
<span class="l l-Scalar l-Scalar-Plain">.idea/</span>
<span class="l l-Scalar l-Scalar-Plain">*.tmproj</span>
<span class="l l-Scalar l-Scalar-Plain">.vscode/</span>
</code></pre></div> <h3 id=values-file>Values File<a class=headerlink href=#values-file title="Permanent link">&para;</a></h3> <p>Every Helm chart needs a <a href=https://helm.sh/docs/chart_template_guide/values_files/ >Values file</a>, which passes values into the <a href=#templates>chart's templates</a> for the build. This is the Values file for this chart:</p> <div class=highlight><span class=filename>/chart/values.yaml</span><pre><span></span><code><span class=nt>image</span><span class=p>:</span>
<span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/cunningpike/fediblockhole</span>
<span class=w>  </span><span class=c1># https://github.com/cunningpike/fediblockhole/pkgs/container/fediblockhole/versions</span>
<span class=w>  </span><span class=c1>#</span>
<span class=w>  </span><span class=c1># alternatively, use `latest` for the latest release or `edge` for the image</span>
<span class=w>  </span><span class=c1># built from the most recent commit</span>
<span class=w>  </span><span class=c1>#</span>
<span class=w>  </span><span class=c1># tag: latest</span>
<span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<span class=w>  </span><span class=c1># use `Always` when using `latest` tag</span>
<span class=w>  </span><span class=nt>pullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>

<span class=nt>fediblockhole</span><span class=p>:</span>
<span class=w>  </span><span class=c1># location of the configuration file. Default is /etc/default/fediblockhole.conf.toml</span>
<span class=w>  </span><span class=nt>conf_file</span><span class=p>:</span>
<span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<span class=w>    </span><span class=nt>filename</span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span>
<span class=w>  </span><span class=nt>cron</span><span class=p>:</span>
<span class=w>    </span><span class=c1># -- run `fediblock-sync` every hour</span>
<span class=w>    </span><span class=nt>sync</span><span class=p>:</span>
<span class=w>      </span><span class=c1># @ignored</span>
<span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=w>      </span><span class=c1># @ignored</span>
<span class=w>      </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s>&quot;0</span><span class=nv> </span><span class=s>*</span><span class=nv> </span><span class=s>*</span><span class=nv> </span><span class=s>*</span><span class=nv> </span><span class=s>*&quot;</span>

<span class=c1># if you manually change the UID/GID environment variables, ensure these values</span>
<span class=c1># match:</span>
<span class=nt>podSecurityContext</span><span class=p>:</span>
<span class=w>  </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">991</span>
<span class=w>  </span><span class=nt>runAsGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">991</span>
<span class=w>  </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">991</span>

<span class=c1># @ignored</span>
<span class=nt>securityContext</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>

<span class=c1># -- Kubernetes manages pods for jobs and pods for deployments differently, so you might</span>
<span class=c1># need to apply different annotations to the two different sets of pods. The annotations</span>
<span class=c1># set with podAnnotations will be added to all deployment-managed pods.</span>
<span class=nt>podAnnotations</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>

<span class=c1># -- The annotations set with jobAnnotations will be added to all job pods.</span>
<span class=nt>jobAnnotations</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>

<span class=c1># -- Default resources for all Deployments and jobs unless overwritten</span>
<span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
<span class=w>  </span><span class=c1># We usually recommend not to specify default resources and to leave this as a conscious</span>
<span class=w>  </span><span class=c1># choice for the user. This also increases chances charts run on environments with little</span>
<span class=w>  </span><span class=c1># resources, such as Minikube. If you do want to specify resources, uncomment the following</span>
<span class=w>  </span><span class=c1># lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.</span>
<span class=w>  </span><span class=c1># limits:</span>
<span class=w>  </span><span class=c1>#   cpu: 100m</span>
<span class=w>  </span><span class=c1>#   memory: 128Mi</span>
<span class=w>  </span><span class=c1># requests:</span>
<span class=w>  </span><span class=c1>#   cpu: 100m</span>
<span class=w>  </span><span class=c1>#   memory: 128Mi</span>

<span class=c1># @ignored</span>
<span class=nt>nodeSelector</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>

<span class=c1># @ignored</span>
<span class=nt>tolerations</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[]</span>

<span class=c1># -- Affinity for all pods unless overwritten</span>
<span class=nt>affinity</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
</code></pre></div> <p>The <code>repository:</code> value points to the location of the <a href=https://github.com/cunningpike/fediblockhole/pkgs/container/fediblockhole>GitHub Package</a> we pushed our Docker image to. The <code>tag:</code> value can be used to override the <code>appVersion:</code> value in the <a href=#chart-file>chart</a>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>We specified a non-root user and group in our Values file to make sure that the containerized script does not run as the root user.</p> </div> <h3 id=templates>Templates<a class=headerlink href=#templates title="Permanent link">&para;</a></h3> <p>All the preceding files are really just metadata for the Helm deployment - the real work is done in the <a href=https://helm.sh/docs/chart_template_guide/getting_started/ >templates</a>.</p> <h4 id=cron-job>Cron Job<a class=headerlink href=#cron-job title="Permanent link">&para;</a></h4> <p>The template for the Kubernetes cron job we needed looks like this:</p> <div class=highlight><span class=filename>/chart/templates/cronjob-fediblock-sync.yaml</span><pre><span></span><code><span class=p>{{</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>fediblockhole</span><span class=p>.</span><span class=nx>cron</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>enabled</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=nx>apiVersion</span><span class=p>:</span><span class=w> </span><span class=nx>batch</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=p>:</span><span class=w> </span><span class=nx>CronJob</span>
<span class=nx>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span><span class=o>-</span><span class=nx>sync</span>
<span class=w>  </span><span class=nx>labels</span><span class=p>:</span>
<span class=w>    </span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.labels&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>nindent</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=p>}}</span>
<span class=nx>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nx>schedule</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>fediblockhole</span><span class=p>.</span><span class=nx>cron</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>schedule</span><span class=w> </span><span class=p>}}</span>
<span class=w>  </span><span class=nx>jobTemplate</span><span class=p>:</span>
<span class=w>    </span><span class=nx>spec</span><span class=p>:</span>
<span class=w>      </span><span class=nx>template</span><span class=p>:</span>
<span class=w>        </span><span class=nx>metadata</span><span class=p>:</span>
<span class=w>          </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span><span class=o>-</span><span class=nx>sync</span>
<span class=w>          </span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>with</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>jobAnnotations</span><span class=w> </span><span class=p>}}</span>
<span class=w>          </span><span class=nx>annotations</span><span class=p>:</span>
<span class=w>            </span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>toYaml</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>nindent</span><span class=w> </span><span class=mi>12</span><span class=w> </span><span class=p>}}</span>
<span class=w>          </span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
<span class=w>        </span><span class=nx>spec</span><span class=p>:</span>
<span class=w>          </span><span class=nx>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=nx>OnFailure</span>
<span class=w>          </span><span class=nx>containers</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span><span class=o>-</span><span class=nx>sync</span>
<span class=hll><span class=w>              </span><span class=nx>image</span><span class=p>:</span><span class=w> </span><span class=s>&quot;{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}&quot;</span>
</span><span class=w>              </span><span class=nx>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>image</span><span class=p>.</span><span class=nx>pullPolicy</span><span class=w> </span><span class=p>}}</span>
<span class=w>              </span><span class=nx>command</span><span class=p>:</span>
<span class=w>                </span><span class=o>-</span><span class=w> </span><span class=nx>fediblock</span><span class=o>-</span><span class=nx>sync</span>
<span class=w>                </span><span class=o>-</span><span class=w> </span><span class=o>-</span><span class=nx>c</span>
<span class=w>                </span><span class=o>-</span><span class=w> </span><span class=s>&quot;{{- include &quot;</span><span class=nx>fediblockhole</span><span class=p>.</span><span class=nx>conf_file_path</span><span class=s>&quot; . -}}{{- include &quot;</span><span class=nx>fediblockhole</span><span class=p>.</span><span class=nx>conf_file_filename</span><span class=s>&quot; . -}}&quot;</span>
<span class=w>              </span><span class=nx>volumeMounts</span><span class=p>:</span>
<span class=w>                </span><span class=o>-</span><span class=w> </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=nx>config</span>
<span class=w>                  </span><span class=nx>mountPath</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_path&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=w>          </span><span class=nx>volumes</span><span class=p>:</span>
<span class=w>            </span><span class=o>-</span><span class=w> </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=nx>config</span>
<span class=w>              </span><span class=nx>configMap</span><span class=p>:</span>
<span class=w>                </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span><span class=o>-</span><span class=nx>conf</span><span class=o>-</span><span class=nx>toml</span>
<span class=w>                </span><span class=nx>items</span><span class=p>:</span>
<span class=w>                </span><span class=o>-</span><span class=w> </span><span class=nx>key</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_filename&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=w>                  </span><span class=nx>path</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_filename&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
</code></pre></div> <p>You can see the values from the <a href=#values-file>Values file</a> (prefixed with <code>.Values.</code>) in the template. An example of where a value from the Values file overrides the default from the Chart is highlighted in the file above.</p> <h4 id=helpers-file>Helpers File<a class=headerlink href=#helpers-file title="Permanent link">&para;</a></h4> <p>There are several values in the template (prefixed with <code>fediblockhole.</code>) that are not defined in either the Values file or the Chart. These are defined in a <a href=https://helm.sh/docs/chart_template_guide/named_templates/ >Helpers file</a>, like this:</p> <div class=highlight><span class=filename>/chart/templates/_helpers.tpl</span><pre><span></span><code><span class=p>{{</span><span class=cm>/* vim: set filetype=mustache: */</span><span class=p>}}</span>
<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Expand the name of the chart.</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.name&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=p>.</span><span class=nx>Chart</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>nameOverride</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trunc</span><span class=w> </span><span class=mi>63</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trimSuffix</span><span class=w> </span><span class=s>&quot;-&quot;</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>

<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Create a default fully qualified app name.</span>
<span class=cm>We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).</span>
<span class=cm>If release name contains chart name it will be used as a full name.</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>fullnameOverride</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>fullnameOverride</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trunc</span><span class=w> </span><span class=mi>63</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trimSuffix</span><span class=w> </span><span class=s>&quot;-&quot;</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=err>$</span><span class=nx>name</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=p>.</span><span class=nx>Chart</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>nameOverride</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>contains</span><span class=w> </span><span class=err>$</span><span class=nx>name</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trunc</span><span class=w> </span><span class=mi>63</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trimSuffix</span><span class=w> </span><span class=s>&quot;-&quot;</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>printf</span><span class=w> </span><span class=s>&quot;%s-%s&quot;</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=err>$</span><span class=nx>name</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trunc</span><span class=w> </span><span class=mi>63</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trimSuffix</span><span class=w> </span><span class=s>&quot;-&quot;</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>

<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Create chart name and version as used by the chart label.</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.chart&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>printf</span><span class=w> </span><span class=s>&quot;%s-%s&quot;</span><span class=w> </span><span class=p>.</span><span class=nx>Chart</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=p>.</span><span class=nx>Chart</span><span class=p>.</span><span class=nx>Version</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>replace</span><span class=w> </span><span class=s>&quot;+&quot;</span><span class=w> </span><span class=s>&quot;_&quot;</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trunc</span><span class=w> </span><span class=mi>63</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>trimSuffix</span><span class=w> </span><span class=s>&quot;-&quot;</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>

<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Common labels</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.labels&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=nx>helm</span><span class=p>.</span><span class=nx>sh</span><span class=o>/</span><span class=nx>chart</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.chart&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.selectorLabels&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>.</span><span class=nx>Chart</span><span class=p>.</span><span class=nx>AppVersion</span><span class=w> </span><span class=p>}}</span>
<span class=nx>app</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>version</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Chart</span><span class=p>.</span><span class=nx>AppVersion</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
<span class=nx>app</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>managed</span><span class=o>-</span><span class=nx>by</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Service</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>

<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Selector labels</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.selectorLabels&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=nx>app</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.name&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span>
<span class=nx>app</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>instance</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Name</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>

<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Rolling pod annotations</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.rollingPodAnnotations&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=nx>rollme</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Revision</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=nx>checksum</span><span class=o>/</span><span class=nx>config</span><span class=o>-</span><span class=nx>configmap</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=nx>print</span><span class=w> </span><span class=err>$</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>BasePath</span><span class=w> </span><span class=s>&quot;/configmap-conf-toml.yaml&quot;</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>sha256sum</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>

<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Create the default conf file path and filename</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_path&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=hll><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s>&quot;/etc/default/&quot;</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>fediblockhole</span><span class=p>.</span><span class=nx>conf_file</span><span class=p>.</span><span class=nx>path</span><span class=w> </span><span class=p>}}</span>
</span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_filename&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=hll><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s>&quot;fediblockhole.conf.toml&quot;</span><span class=w> </span><span class=p>.</span><span class=nx>Values</span><span class=p>.</span><span class=nx>fediblockhole</span><span class=p>.</span><span class=nx>conf_file</span><span class=p>.</span><span class=nx>filename</span><span class=w> </span><span class=p>}}</span>
</span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
</code></pre></div> <p>You can see how values from both the <a href=#chart-file>Chart file</a> and the <a href=#values-file>Values file</a> are combined to define other values that are then used in the <a href=#cron-job>cron job template</a>.</p> <p>A slightly different syntax for defining defaults and overrides is highlighted above, showing how the local path and filename for the FediBlockHole configuration has a default value of <code>/etc/default/fediblockhole.conf.toml</code> from the <a href=#chart-file>Chart file</a> if a value is not set in the <a href=#values-file>Values file</a>.</p> <h4 id=configuration-file>Configuration File<a class=headerlink href=#configuration-file title="Permanent link">&para;</a></h4> <p>As pointed out at the start, FediBlockHole was intended to be deployed on a machine with a persistant storage system, and read a <a href=https://toml.io/en/v1.0.0>TOML-formatted</a> configuration file from a local filepath. This poses a challenge when containerizing it, as we need to be able to easily make changes to the configuration file and redeploy the cron job with the updated values into the pod's local file system where the script expects to find it. We also want to make sure that the container is rebuilt with the new configuration file when the changes are made to it.</p> <p>There are a few tricks in the various files that we used to accomplish this. First, we created a <a href=https://kubernetes.io/docs/concepts/configuration/configmap/ >ConfigMap</a> template, which globs a copy of the default configuration file stored in the root of the chart into a ConfigMap entry:</p> <div class=highlight><span class=filename>/chart/templates/configmap-conf-toml.yaml</span><pre><span></span><code><span class=nx>apiVersion</span><span class=p>:</span><span class=w> </span><span class=nx>v1</span>
<span class=nx>kind</span><span class=p>:</span><span class=w> </span><span class=nx>ConfigMap</span>
<span class=nx>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span><span class=o>-</span><span class=nx>conf</span><span class=o>-</span><span class=nx>toml</span>
<span class=w>  </span><span class=nx>labels</span><span class=p>:</span>
<span class=w>    </span><span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.labels&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>nindent</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=p>}}</span>
<span class=nx>data</span><span class=p>:</span>
<span class=w>  </span><span class=p>{{</span><span class=w> </span><span class=p>(.</span><span class=nx>Files</span><span class=p>.</span><span class=nx>Glob</span><span class=w> </span><span class=s>&quot;fediblockhole.conf.toml&quot;</span><span class=p>).</span><span class=nx>AsConfig</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>nindent</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=p>}}</span>
</code></pre></div> <p>Next, we included in the container spec a local filesystem mount that mounts the configuration file into the expected location in the container's local filesystem:</p> <div class=highlight><span class=filename>/chart/templates/cronjob-fediblock-sync.yaml</span><pre><span></span><code><span class=o>...</span>
<span class=nx>spec</span><span class=p>:</span>
<span class=w>  </span><span class=o>...</span>
<span class=w>  </span><span class=nx>containers</span><span class=p>:</span>
<span class=w>    </span><span class=o>...</span>
<span class=w>      </span><span class=nx>volumeMounts</span><span class=p>:</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=nx>config</span>
<span class=w>          </span><span class=nx>mountPath</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_path&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=w>  </span><span class=nx>volumes</span><span class=p>:</span>
<span class=w>    </span><span class=o>-</span><span class=w> </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=nx>config</span>
<span class=w>      </span><span class=nx>configMap</span><span class=p>:</span>
<span class=w>        </span><span class=nx>name</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.fullname&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>}}</span><span class=o>-</span><span class=nx>conf</span><span class=o>-</span><span class=nx>toml</span>
<span class=w>        </span><span class=nx>items</span><span class=p>:</span>
<span class=w>        </span><span class=o>-</span><span class=w> </span><span class=nx>key</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_filename&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=w>          </span><span class=nx>path</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=s>&quot;fediblockhole.conf_file_filename&quot;</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
</code></pre></div> <p>Finally, we set the container to <a href=https://renehernandez.io/notes/rolling-pods-config-changes/ >restart when a change to the ConfigMap is detected</a> by <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/ >annotating</a> it with the checksum of the ConfigMap:</p> <div class=highlight><span class=filename>/chart/templates/_helpers.tpl</span><pre><span></span><code><span class=o>...</span>
<span class=p>{{</span><span class=cm>/*</span>
<span class=cm>Rolling pod annotations</span>
<span class=cm>*/</span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>define</span><span class=w> </span><span class=s>&quot;fediblockhole.rollingPodAnnotations&quot;</span><span class=w> </span><span class=o>-</span><span class=p>}}</span>
<span class=nx>rollme</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=p>.</span><span class=nx>Release</span><span class=p>.</span><span class=nx>Revision</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=nx>checksum</span><span class=o>/</span><span class=nx>config</span><span class=o>-</span><span class=nx>configmap</span><span class=p>:</span><span class=w> </span><span class=p>{{</span><span class=w> </span><span class=nx>include</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=nx>print</span><span class=w> </span><span class=err>$</span><span class=p>.</span><span class=nx>Template</span><span class=p>.</span><span class=nx>BasePath</span><span class=w> </span><span class=s>&quot;/configmap-conf-toml.yaml&quot;</span><span class=w> </span><span class=p>)</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>sha256sum</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nx>quote</span><span class=w> </span><span class=p>}}</span>
<span class=p>{{</span><span class=o>-</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=p>}}</span>
<span class=o>...</span>
</code></pre></div> <p>All this ensures that a new container image is generated with the latest configuration file in the correct location in its local filesystem, each time a change is made to the ConfigMap.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Remember that references to the ConfigMap in the chart are relative to the repository from which the Helm Release will actually be run. This will be <strong>our</strong> Flux/Helm repository that we <a href=../fluxhelm/ >prepared earlier</a>, allowing us to specify our <strong>own</strong> ConfigMap containing <strong>our</strong> version of the configuration file.</p> </div> <h3 id=oauth-token>OAuth Token<a class=headerlink href=#oauth-token title="Permanent link">&para;</a></h3> <p>In order to push blocks to your Mastodon instance, you will need a <a href=/operating/mastodon/#mastodon-oauth-token>Mastodon OAuth token</a> with <code>admin:read</code> and <code>admin:write</code> scopes. You will paste the value from the <code>Your access token</code> field in the Mastodon <code>Development</code> screen into this block of the <a href=#configuration-file>FediBlockHole configuration file</a> as highlighted here:</p> <div class=highlight><pre><span></span><code><span class=c1># List of instances to write blocklist to</span>
<span class=n>blocklist_instance_destinations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<span class=hll><span class=w>  </span><span class=p>{</span><span class=w> </span><span class=n>domain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#39;{my-web_domain}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#39;[redacted]&#39;</span><span class=p>,</span><span class=w> </span><span class=n>max_followed_severity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#39;silence&#39;</span><span class=p>},</span>
</span><span class=p>]</span>
</code></pre></div> <p>You won't need to set the <code>Redirect URI</code> to anything other than the default - it's just the token that FediBlockHole needs.</p> <div class="admonition danger"> <p class=admonition-title>Danger, Will Robinson</p> <p><strong>Protect your FediBlockHole configuration file carefully</strong> once this token is placed in it, and rotate the token regularly. If compromised, it is all anyone will need to have full admin access to your instance via the API.</p> </div> <h3 id=deploying-fediblockhole>Deploying FediBlockHole<a class=headerlink href=#deploying-fediblockhole title="Permanent link">&para;</a></h3> <p>Deploying our FediBlockHole cron job into our cluster followed an identical pattern to how we <a href=../mastodon/ >deployed Mastodon</a>. We prepared our deployment by creating a GitHub repository source and namespace for our cron job:</p> <div class=highlight><span class=filename>/clusters/{my-cluster}/gitrepositories/gitrepository-fediblockhole.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.toolkit.fluxcd.io/v1beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class=w>  </span><span class=nt>ref</span><span class=p>:</span>
<span class=w>    </span><span class=nt>branch</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/cunningpike/fediblockhole/</span>
</code></pre></div> <div class=highlight><span class=filename>/clusters/{my-cluster}/namespaces/namespace-fediblockhole.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
</code></pre></div> <p>Next, we created the Flux kustomization:</p> <div class=highlight><span class=filename>/clusters/{my-cluster}/kustomizations/kustomization-fediblockhole.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.toolkit.fluxcd.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./fediblockhole</span>
<span class=w>  </span><span class=nt>prune</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w> </span><span class=c1># remove any elements later removed from the above path</span>
<span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2m</span><span class=w> </span><span class=c1># if not set, this defaults to interval duration, which is 1h</span>
<span class=w>  </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=w>  </span><span class=nt>validation</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
</code></pre></div> <p>Then, we created our own version of the ConfigMap that configures the FediBlockHole cron job itself:</p> <details class=example> <summary>/fediblockhole/configmap-fediblockhole-helm-chart-value-overrides.yaml</summary> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole-helm-chart-value-overrides</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=nt>data</span><span class=p>:</span>
<span class=w>  </span><span class=nt>values.yaml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span><span class=w>  </span>
<span class=w>    </span><span class=no>image:</span>
<span class=w>      </span><span class=no>repository: ghcr.io/cunningpike/fediblockhole</span>
<span class=w>      </span><span class=no># https://github.com/cunningpike/fediblockhole/pkgs/container/fediblockhole/versions</span>
<span class=w>      </span><span class=no>#</span>
<span class=w>      </span><span class=no># alternatively, use `latest` for the latest release or `edge` for the image</span>
<span class=w>      </span><span class=no># built from the most recent commit</span>
<span class=w>      </span><span class=no>#</span>
<span class=w>      </span><span class=no># tag: latest</span>
<span class=w>      </span><span class=no>tag: &quot;&quot;</span>
<span class=w>      </span><span class=no># use `Always` when using `latest` tag</span>
<span class=w>      </span><span class=no>pullPolicy: IfNotPresent</span>

<span class=w>    </span><span class=no>fediblockhole:</span>
<span class=w>      </span><span class=no># location of the configuration file. Default is /etc/default/fediblockhole.conf.toml</span>
<span class=w>      </span><span class=no>conf_file:</span>
<span class=w>        </span><span class=no>path: &quot;&quot;</span>
<span class=w>        </span><span class=no>filename: &quot;&quot;</span>
<span class=w>      </span><span class=no>cron:</span>
<span class=w>        </span><span class=no># -- run `fediblock-sync` every hour</span>
<span class=w>        </span><span class=no>sync:</span>
<span class=w>          </span><span class=no># @ignored</span>
<span class=w>          </span><span class=no>enabled: true</span>
<span class=w>          </span><span class=no># @ignored</span>
<span class=w>          </span><span class=no>schedule: &quot;0 */2 * * *&quot;</span>

<span class=w>    </span><span class=no># if you manually change the UID/GID environment variables, ensure these values</span>
<span class=w>    </span><span class=no># match:</span>
<span class=w>    </span><span class=no>podSecurityContext:</span>
<span class=w>      </span><span class=no>runAsUser: 991</span>
<span class=w>      </span><span class=no>runAsGroup: 991</span>
<span class=w>      </span><span class=no>fsGroup: 991</span>

<span class=w>    </span><span class=no># @ignored</span>
<span class=w>    </span><span class=no>securityContext: {}</span>

<span class=w>    </span><span class=no># -- Kubernetes manages pods for jobs and pods for deployments differently, so you might</span>
<span class=w>    </span><span class=no># need to apply different annotations to the two different sets of pods. The annotations</span>
<span class=w>    </span><span class=no># set with podAnnotations will be added to all deployment-managed pods.</span>
<span class=w>    </span><span class=no>podAnnotations: {}</span>

<span class=w>    </span><span class=no># -- The annotations set with jobAnnotations will be added to all job pods.</span>
<span class=w>    </span><span class=no>jobAnnotations: {}</span>

<span class=w>    </span><span class=no># -- Default resources for all Deployments and jobs unless overwritten</span>
<span class=w>    </span><span class=no>resources: {}</span>
<span class=w>      </span><span class=no># We usually recommend not to specify default resources and to leave this as a conscious</span>
<span class=w>      </span><span class=no># choice for the user. This also increases chances charts run on environments with little</span>
<span class=w>      </span><span class=no># resources, such as Minikube. If you do want to specify resources, uncomment the following</span>
<span class=w>      </span><span class=no># lines, adjust them as necessary, and remove the curly braces after &#39;resources:&#39;.</span>
<span class=w>      </span><span class=no># limits:</span>
<span class=w>      </span><span class=no>#   cpu: 100m</span>
<span class=w>      </span><span class=no>#   memory: 128Mi</span>
<span class=w>      </span><span class=no># requests:</span>
<span class=w>      </span><span class=no>#   cpu: 100m</span>
<span class=w>      </span><span class=no>#   memory: 128Mi</span>

<span class=w>    </span><span class=no># @ignored</span>
<span class=w>    </span><span class=no>nodeSelector: {}</span>

<span class=w>    </span><span class=no># @ignored</span>
<span class=w>    </span><span class=no>tolerations: []</span>

<span class=w>    </span><span class=no># -- Affinity for all pods unless overwritten</span>
<span class=w>    </span><span class=no>affinity: {}</span>
</code></pre></div> </details> <p>The only changes you need to make in this file are:</p> <ul> <li>Set <code>fediblockhole.cron.sync.enabled:</code> to <code>true</code>.</li> <li>Set the desired crontab value in <code>fediblockhole.cron.sync.schedule:</code>. We started with <code>"0 */2 * * *"</code> initially, as shown, but have since reduced that to <code>"0 * * * *"</code> as updates are much faster after the initial sync.</li> </ul> <p>After that, we set up our version of the FediBlockHole configuration file:</p> <details class=example> <summary>/fediblockhole/configmap-fediblockhole-conf-toml.yaml</summary> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole-conf-toml</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=nt>data</span><span class=p>:</span>
<span class=w>  </span><span class=nt>fediblockhole.conf.toml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span><span class=w>  </span>
<span class=w>    </span><span class=no># List of instances to read blocklists from.</span>
<span class=w>    </span><span class=no># If the instance makes its blocklist public, no authorization token is needed.</span>
<span class=w>    </span><span class=no>#   Otherwise, `token` is a Bearer token authorised to read domain_blocks.</span>
<span class=w>    </span><span class=no># If `admin` = True, use the more detailed admin API, which requires a token with a </span>
<span class=w>    </span><span class=no>#   higher level of authorization.</span>
<span class=w>    </span><span class=no># If `import_fields` are provided, only import these fields from the instance.</span>
<span class=w>    </span><span class=no>#   Overrides the global `import_fields` setting.</span>
<span class=w>    </span><span class=no>blocklist_instance_sources = [</span>
<span class=w>      </span><span class=no># { domain = &#39;public.blocklist&#39;}, # an instance with a public list of domain_blocks</span>
<span class=w>      </span><span class=no># { domain = &#39;jorts.horse&#39;, token = &#39;&lt;a_different_token&gt;&#39; }, # user accessible block list</span>
<span class=w>      </span><span class=no># { domain = &#39;eigenmagic.net&#39;, token = &#39;&lt;a_token_with_read_auth&gt;&#39;, admin = true }, # admin access required</span>
<span class=w>    </span><span class=no>]</span>

<span class=w>    </span><span class=no># List of URLs to read csv blocklists from</span>
<span class=w>    </span><span class=no># Format tells the parser which format to use when parsing the blocklist</span>
<span class=w>    </span><span class=no># max_severity tells the parser to override any severities that are higher than this value</span>
<span class=w>    </span><span class=no># import_fields tells the parser to only import that set of fields from a specific source</span>
<span class=w>    </span><span class=no>blocklist_url_sources = [</span>
<span class=w>      </span><span class=no># { url = &#39;file:///path/to/fediblockhole/samples/demo-blocklist-01.csv&#39;, format = &#39;csv&#39; },</span>
<span class=w>      </span><span class=no>{ url = &#39;https://codeberg.org/oliphant/blocklists/raw/branch/main/blocklists/_unified_min_blocklist.csv&#39;, format = &#39;csv&#39; },</span>
<span class=w>      </span><span class=no>{ url = &#39;https://rapidblock.org/blocklist.json&#39;, format = &#39;rapidblock.json&#39; },</span>
<span class=w>    </span><span class=no>]</span>

<span class=w>    </span><span class=no>## These global allowlists override blocks from blocklists</span>
<span class=w>    </span><span class=no># These are the same format and structure as blocklists, but they take precedence</span>
<span class=w>    </span><span class=no>allowlist_url_sources = [</span>
<span class=w>      </span><span class=no># { url = &#39;https://raw.githubusercontent.com/eigenmagic/fediblockhole/main/samples/demo-allowlist-01.csv&#39;, format = &#39;csv&#39; },</span>
<span class=w>      </span><span class=no>{ url = &#39;https://codeberg.org/oliphant/blocklists/raw/branch/main/blocklists/__allowlist.csv&#39;, format = &#39;csv&#39; },</span>
<span class=w>    </span><span class=no>]</span>

<span class=w>    </span><span class=no># List of instances to write blocklist to</span>
<span class=w>    </span><span class=no>blocklist_instance_destinations = [</span>
<span class=w>      </span><span class=no>{ domain = &#39;mastodon.govsocial.org&#39;, token = &#39;[redacted]&#39;, max_followed_severity = &#39;silence&#39;},</span>
<span class=w>    </span><span class=no>]</span>

<span class=w>    </span><span class=no>## Store a local copy of the remote blocklists after we fetch them</span>
<span class=w>    </span><span class=no>#save_intermediate = true</span>

<span class=w>    </span><span class=no>## Directory to store the local blocklist copies</span>
<span class=w>    </span><span class=no># savedir = &#39;/tmp&#39;</span>

<span class=w>    </span><span class=no>## File to save the fully merged blocklist into</span>
<span class=w>    </span><span class=no># blocklist_savefile = &#39;/tmp/merged_blocklist.csv&#39;</span>

<span class=w>    </span><span class=no>## Don&#39;t push blocklist to instances, even if they&#39;re defined above</span>
<span class=w>    </span><span class=no># no_push_instance = false</span>

<span class=w>    </span><span class=no>## Don&#39;t fetch blocklists from URLs, even if they&#39;re defined above</span>
<span class=w>    </span><span class=no># no_fetch_url = false</span>

<span class=w>    </span><span class=no>## Don&#39;t fetch blocklists from instances, even if they&#39;re defined above</span>
<span class=w>    </span><span class=no># no_fetch_instance = false</span>

<span class=w>    </span><span class=no>## Set the mergeplan to use when dealing with overlaps between blocklists</span>
<span class=w>    </span><span class=no># The default &#39;max&#39; mergeplan will use the harshest severity block found for a domain.</span>
<span class=w>    </span><span class=no># The &#39;min&#39; mergeplan will use the lightest severity block found for a domain.</span>
<span class=w>    </span><span class=no># mergeplan = &#39;max&#39;</span>

<span class=w>    </span><span class=no>## Set which fields we import</span>
<span class=w>    </span><span class=no>## &#39;domain&#39; and &#39;severity&#39; are always imported, these are additional</span>
<span class=w>    </span><span class=no>## </span>
<span class=w>    </span><span class=no>import_fields = [&#39;public_comment&#39;, &#39;reject_media&#39;, &#39;reject_reports&#39;, &#39;obfuscate&#39;]</span>

<span class=w>    </span><span class=no>## Set which fields we export</span>
<span class=w>    </span><span class=no>## &#39;domain&#39; and &#39;severity&#39; are always exported, these are additional</span>
<span class=w>    </span><span class=no>## </span>
<span class=w>    </span><span class=no>export_fields = [&#39;public_comment&#39;]</span>
</code></pre></div> </details> <p>More information about how we chose our block list sources can be found <a href=/operating/mastodon/#server-moderation>here</a>.</p> <p>Finally, we created the Helm Release that deployed the configured cron job into our cluster:</p> <div class=highlight><span class=filename>/fediblockhole/helmrelease-fediblockhole.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>      </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./chart</span>
<span class=w>      </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">15m</span>
<span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class=w>  </span><span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole</span>
<span class=w>  </span><span class=nt>valuesFrom</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">fediblockhole-helm-chart-value-overrides</span>
<span class=w>    </span><span class=nt>valuesKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">values.yaml</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>A Couple of Notes</p> <ul> <li>Rate-limiting (either in our <a href=../mastodon/#ingress_1>Ingress</a> or in the Mastodon API itself) makes running FediBlockHole on our instance a relatively slow operation, at least for an initial load. YMMV, but we recommend setting your <code>fediblockhole.cron.sync.schedule:</code> to a fairly lengthy interval (at least 2 hours) until you get a feel for how long a typical run takes in your environment.</li> <li>FediBlockHole currently does <strong>NOT</strong> delete expired blocks i.e. if an existing block in your instance is no longer in a pulled list, it needs to be removed manually. We are planning to contribute code to the FediBlockProject to implement this feature.</li> <li>v1.0.0 of our Helm chart for FediBlockHole does not include ConfigMaps for the local file import functionality. This will be included in the next release.</li> </ul> </div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 6, 2023</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 Anthony Rodgers, GOVSocial </div> </div> <div class=md-social> <a href=https://mstdn.ca/@cunningpike target=_blank rel=noopener title=mstdn.ca class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> <a href=https://github.com/govsocial-org target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://docs.govsocial.org/ target=_blank rel=noopener title=docs.govsocial.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20 5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"/></svg> </a> <a href=https://www.linkedin.com/in/anthonylrodgers target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=mailto:cunningpike@gmail.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 4H7a5 5 0 0 0-5 5v11h18a2 2 0 0 0 2-2V9a5 5 0 0 0-5-5m-7 14H4V9a3 3 0 0 1 3-3 3 3 0 0 1 3 3v9m9-3h-2v-2h-4v-2h6v4M9 11H5V9h4v2Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.sections", "navigation.indexes", "navigation.top", "navigation.pruning", "search.suggest", "search.share", "content.code.annotate", "content.code.copy", "header.autohide", "announce.dismiss", "toc.follow"], "search": "../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.a00a7c5e.min.js></script> <script src=../../extras/javascript/plausible.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../../extras/javascript/tablesort.js></script> </body> </html>